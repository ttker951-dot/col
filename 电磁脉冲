local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

if not RunService:IsClient() then
    warn("èƒ½é‡è„‰å†²ç‰¹æ•ˆä»…å®¢æˆ·ç«¯ç”Ÿæ•ˆ")
end

-- ğŸ”¥ èƒ½é‡è„‰å†²é…è‰²æ–¹æ¡ˆ
local EnergyPulsePalette = {
    -- ä¸»è¦é¢œè‰²
    DeepSpaceBlue = Color3.fromRGB(0, 20, 255),      -- æ·±ç©ºè“ #0014FF
    ElectricPurple = Color3.fromRGB(148, 0, 211),    -- ç”µç¦»ç´« #9400D3
    LaserCyan = Color3.fromRGB(0, 255, 255),         -- é•­å°„é’ #00FFFF
    WhiteHot = Color3.fromRGB(255, 255, 240),        -- ç™½ç‚½ #FFFFF0
    PlasmaGold = Color3.fromRGB(255, 215, 0),        -- ç­‰ç¦»å­é‡‘ #FFD700
    BlazingOrange = Color3.fromRGB(255, 140, 0),     -- ç¼çƒ­æ©™ #FF8C00
    
    -- æ¸å˜é¢„è®¾
    BluePurplePulse = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 20, 255)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(148, 0, 211)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 20, 255))
    }),
    
    CyanWhiteBurst = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 255, 255)),
        ColorSequenceKeypoint.new(0.3, Color3.fromRGB(255, 255, 240)),
        ColorSequenceKeypoint.new(0.7, Color3.fromRGB(255, 255, 240)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 255, 255))
    }),
    
    GoldOrangeEnergy = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 215, 0)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 140, 0)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 215, 0))
    }),
    
    TriplePulse = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 20, 255)),
        ColorSequenceKeypoint.new(0.3, Color3.fromRGB(148, 0, 211)),
        ColorSequenceKeypoint.new(0.6, Color3.fromRGB(0, 255, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 20, 255))
    })
}

-- âš¡ è„‰å†²æ•ˆæœå‡½æ•°
local function applyEnergyPulseEffect(effect)
    pcall(function()
        if effect:IsA("ParticleEmitter") then
            -- éšæœºé€‰æ‹©è„‰å†²æ–¹æ¡ˆ
            local schemes = {
                EnergyPulsePalette.BluePurplePulse,
                EnergyPulsePalette.CyanWhiteBurst,
                EnergyPulsePalette.GoldOrangeEnergy,
                EnergyPulsePalette.TriplePulse
            }
            effect.Color = schemes[math.random(1, #schemes)]
            
            -- å¢å¼ºèƒ½é‡æ•ˆæœ
            effect.LightEmission = math.clamp(effect.LightEmission or 0.3, 0.5, 1)
            effect.LightInfluence = 0
            effect.Size = NumberSequence.new({
                NumberSequenceKeypoint.new(0, (effect.Size and effect.Size.Keypoints[1].Value or 1) * 0.8),
                NumberSequenceKeypoint.new(0.5, (effect.Size and effect.Size.Keypoints[1].Value or 1) * 1.5),
                NumberSequenceKeypoint.new(1, (effect.Size and effect.Size.Keypoints[1].Value or 1) * 0.8)
            })
            
        elseif effect:IsA("Beam") then
            -- å…‰æŸèƒ½é‡è„‰å†²
            effect.Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, EnergyPulsePalette.DeepSpaceBlue),
                ColorSequenceKeypoint.new(0.3, EnergyPulsePalette.ElectricPurple),
                ColorSequenceKeypoint.new(0.6, EnergyPulsePalette.LaserCyan),
                ColorSequenceKeypoint.new(1, EnergyPulsePalette.DeepSpaceBlue)
            })
            effect.Width0 = (effect.Width0 or 0.5) * 1.2
            effect.Width1 = (effect.Width1 or 0.5) * 1.2
            
        elseif effect:IsA("Trail") then
            effect.Color = EnergyPulsePalette.CyanWhiteBurst
            effect.LightEmission = 1
            
        elseif effect:IsA("Smoke") then
            effect.Color = Color3.fromRGB(100, 200, 255) -- èƒ½é‡çƒŸé›¾è“
            effect.Opacity = 0.4
            effect.RiseVelocity = (effect.RiseVelocity or 1) * 1.5
            
        elseif effect:IsA("Fire") then
            -- èƒ½é‡ç«ç„°
            effect.Color = EnergyPulsePalette.GoldOrangeEnergy
            effect.Size = (effect.Size or 5) * 1.5
            effect.Heat = (effect.Heat or 10) * 1.2
            
        elseif effect:IsA("Sparkles") then
            effect.SparkleColor = EnergyPulsePalette.LaserCyan
            effect.SparkleSize = (effect.SparkleSize or 1) * 1.3
            
        elseif effect:IsA("Explosion") then
            effect.BlastPressure = (effect.BlastPressure or 500) * 0.8
            effect.BlastRadius = (effect.BlastRadius or 5) * 1.2
            -- Explosioné¢œè‰²éœ€é€šè¿‡ParticleEmitterå®ç°
        end
        
        -- æ·»åŠ èƒ½é‡è„‰å†²æ ‡è®°
        effect:SetAttribute("EnergyPulse", true)
        effect:SetAttribute("PulseIntensity", math.random(80, 100) / 100)
        
        -- å¯é€‰ï¼šæ·»åŠ è„‰å†²åŠ¨ç”»ï¼ˆé€šè¿‡RunServiceï¼‰
        if effect:IsA("ParticleEmitter") or effect:IsA("Beam") then
            effect:SetAttribute("PulseEnabled", true)
        end
    end)
end

-- ğŸŒŒ åº”ç”¨æ‰€æœ‰ç‰¹æ•ˆ
local function dyeAllEnergyPulse()
    print("âš¡ å¼€å§‹åº”ç”¨èƒ½é‡è„‰å†²ç‰¹æ•ˆ...")
    local effectTypes = {"ParticleEmitter", "Beam", "Trail", "Smoke", "Fire", "Sparkles", "Explosion"}
    local totalEffects = 0
    local dyedEffects = 0
    
    for _, descendant in ipairs(game:GetDescendants()) do
        for _, effectType in ipairs(effectTypes) do
            if descendant:IsA(effectType) then
                totalEffects = totalEffects + 1
                if not descendant:GetAttribute("EnergyPulse") then
                    applyEnergyPulseEffect(descendant)
                    dyedEffects = dyedEffects + 1
                end
            end
        end
    end
    
    print(string.format("âœ… èƒ½é‡è„‰å†²åº”ç”¨å®Œæˆï¼æ€»è®¡ %d ä¸ªç‰¹æ•ˆï¼Œæ–°å¢ %d ä¸ªè„‰å†²æ•ˆæœ", totalEffects, dyedEffects))
    
    -- å…¨å±€è®¿é—®æ¥å£
    _G.EnergyPulseEffects = {
        Reapply = dyeAllEnergyPulse,
        Palette = EnergyPulsePalette,
        DyeFunction = applyEnergyPulseEffect,
        Pulse = function(intensity)
            -- æ§åˆ¶è„‰å†²å¼ºåº¦
            for _, effect in ipairs(game:GetDescendants()) do
                if effect:GetAttribute("EnergyPulse") then
                    effect:SetAttribute("PulseIntensity", intensity or 1)
                end
            end
        end
    }
    
    return dyedEffects
end

-- ğŸš€ åˆå§‹æ‰§è¡Œ
dyeAllEnergyPulse()

print("âš¡ èƒ½é‡è„‰å†²ç³»ç»Ÿå·²æ¿€æ´»")
print("ğŸ’« æ·±ç©ºè“ + ç”µç¦»ç´« + é•­å°„é’")
print("ğŸ”¥ ç­‰ç¦»å­é‡‘ + ç¼çƒ­æ©™ è„‰å†²æ•ˆæœ")

-- ğŸ”„ ç›‘å¬æ–°ç‰¹æ•ˆ
game.DescendantAdded:Connect(function(newDescendant)
    task.wait(0.05)
    local effectTypes = {"ParticleEmitter", "Beam", "Trail", "Smoke", "Fire", "Sparkles", "Explosion"}
    for _, effectType in ipairs(effectTypes) do
        if newDescendant:IsA(effectType) then
            task.wait(0.1)
            if not newDescendant:GetAttribute("EnergyPulse") then
                applyEnergyPulseEffect(newDescendant)
                print("âœ¨ æ–°èƒ½é‡è„‰å†²æ•ˆæœ:", newDescendant:GetFullName())
            end
        end
    end
end)

-- âš¡ å…¨å±€è„‰å†²æ§åˆ¶å‡½æ•°
function PulseAllEffects(intensity)
    intensity = intensity or 1
    for _, effect in ipairs(game:GetDescendants()) do
        if effect:GetAttribute("EnergyPulse") and effect:IsA("ParticleEmitter") then
            local currentSize = effect.Size
            if currentSize then
                effect.Size = NumberSequence.new({
                    NumberSequenceKeypoint.new(0, currentSize.Keypoints[1].Value * intensity),
                    NumberSequenceKeypoint.new(0.5, currentSize.Keypoints[2].Value * intensity * 1.5),
                    NumberSequenceKeypoint.new(1, currentSize.Keypoints[3].Value * intensity)
                })
            end
        end
    end
    print("âš¡ å…¨å±€è„‰å†²å¼ºåº¦:", intensity)
end

-- å¯¼å‡ºæ§åˆ¶å‡½æ•°
return {
    Apply = dyeAllEnergyPulse,
    Pulse = PulseAllEffects,
    Colors = EnergyPulsePalette
}
