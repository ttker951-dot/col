local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

if not RunService:IsClient() then
    warn("ç†”å²©åœ°ç‹±ç‰¹æ•ˆä»…å®¢æˆ·ç«¯ç”Ÿæ•ˆ")
end

-- ğŸŒ‹ ç†”å²©åœ°ç‹±é…è‰²æ–¹æ¡ˆ
local LavaHellPalette = {
    -- ç†”å²©æ ¸å¿ƒè‰²
    MagmaCore = Color3.fromRGB(255, 69, 0),          -- å²©æµ†æ ¸å¿ƒæ©™ #FF4500
    HellfireRed = Color3.fromRGB(255, 0, 0),         -- åœ°ç‹±ç«çº¢ #FF0000
    LavaOrange = Color3.fromRGB(255, 140, 0),        -- ç†”å²©æ©™ #FF8C00
    MoltenGold = Color3.fromRGB(255, 215, 0),        -- ç†”é‡‘ #FFD700
    
    -- åœ°ç‹±ç¯å¢ƒè‰²
    AshBlack = Color3.fromRGB(20, 20, 20),           -- ç«å±±ç°é»‘ #141414
    CharcoalGray = Color3.fromRGB(50, 50, 50),       -- ç„¦ç‚­ç° #323232
    CrackOrange = Color3.fromRGB(255, 165, 0),       -- åœ°è£‚æ©™ #FFA500
    EmberRed = Color3.fromRGB(178, 34, 34),          -- ä½™çƒ¬çº¢ #B22222
    
    -- é«˜æ¸©è‰²
    WhiteHot = Color3.fromRGB(255, 255, 240),        -- ç™½ç‚½ #FFFFF0
    YellowHot = Color3.fromRGB(255, 255, 150),       -- é»„ç‚½ #FFFF96
    InfernoYellow = Color3.fromRGB(255, 255, 0),     -- ç‚¼ç‹±é»„ #FFFF00
    
    -- æ¸å˜é¢„è®¾
    MagmaFlow = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 240)),    -- ç™½ç‚½æ ¸å¿ƒ
        ColorSequenceKeypoint.new(0.2, Color3.fromRGB(255, 215, 0)),    -- ç†”é‡‘
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 69, 0)),     -- å²©æµ†æ©™
        ColorSequenceKeypoint.new(0.8, Color3.fromRGB(178, 34, 34)),    -- ä½™çƒ¬çº¢
        ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 20, 20))        -- ç°çƒ¬é»‘
    }),
    
    HellfireBlast = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 150)),    -- é»„ç‚½
        ColorSequenceKeypoint.new(0.1, Color3.fromRGB(255, 255, 0)),    -- ç‚¼ç‹±é»„
        ColorSequenceKeypoint.new(0.3, Color3.fromRGB(255, 0, 0)),      -- åœ°ç‹±ç«çº¢
        ColorSequenceKeypoint.new(0.7, Color3.fromRGB(255, 69, 0)),     -- å²©æµ†æ©™
        ColorSequenceKeypoint.new(1, Color3.fromRGB(50, 50, 50))        -- ç„¦ç‚­ç°
    }),
    
    CrackGlow = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(20, 20, 20)),       -- é»‘
        ColorSequenceKeypoint.new(0.3, Color3.fromRGB(255, 165, 0)),    -- åœ°è£‚æ©™
        ColorSequenceKeypoint.new(0.6, Color3.fromRGB(255, 69, 0)),     -- å²©æµ†æ©™
        ColorSequenceKeypoint.new(0.9, Color3.fromRGB(255, 165, 0)),    -- åœ°è£‚æ©™
        ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 20, 20))        -- é»‘
    }),
    
    EmberPulse = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(50, 50, 50)),       -- ç°
        ColorSequenceKeypoint.new(0.2, Color3.fromRGB(178, 34, 34)),    -- ä½™çƒ¬çº¢
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 69, 0)),     -- å²©æµ†æ©™
        ColorSequenceKeypoint.new(0.8, Color3.fromRGB(178, 34, 34)),    -- ä½™çƒ¬çº¢
        ColorSequenceKeypoint.new(1, Color3.fromRGB(50, 50, 50))        -- ç°
    }),
    
    VolcanicSmoke = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 140, 0)),      -- ç†”å²©æ©™
        ColorSequenceKeypoint.new(0.3, Color3.fromRGB(139, 69, 19)),    -- æ£•è‰²
        ColorSequenceKeypoint.new(0.6, Color3.fromRGB(105, 105, 105)),  -- æš—ç°
        ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 20, 20))        -- é»‘
    }),
    
    LavaSplash = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 240)),    -- ç™½ç‚½
        ColorSequenceKeypoint.new(0.1, Color3.fromRGB(255, 215, 0)),    -- ç†”é‡‘
        ColorSequenceKeypoint.new(0.4, Color3.fromRGB(255, 69, 0)),     -- å²©æµ†æ©™
        ColorSequenceKeypoint.new(0.6, Color3.fromRGB(255, 0, 0)),      -- åœ°ç‹±ç«
        ColorSequenceKeypoint.new(1, Color3.fromRGB(139, 69, 19))       -- å†·å´æ£•
    })
}

-- ğŸ”¥ åœ°ç‹±ç«ç„°æ•ˆæœå‡½æ•°
local function applyLavaHellEffect(effect)
    pcall(function()
        local effectName = effect.Name:lower()
        local isFire = string.find(effectName, "fire") or string.find(effectName, "flame") or string.find(effectName, "burn")
        local isLava = string.find(effectName, "lava") or string.find(effectName, "magma") or string.find(effectName, "molten")
        local isExplosion = string.find(effectName, "explo") or string.find(effectName, "blast") or string.find(effectName, "bomb")
        local isSmoke = string.find(effectName, "smoke") or string.find(effectName, "ash") or string.find(effectName, "fume")
        
        if effect:IsA("ParticleEmitter") then
            -- é€‰æ‹©ç†”å²©æ–¹æ¡ˆ
            local scheme
            local sizeMultiplier = 1
            
            if isFire then
                scheme = LavaHellPalette.HellfireBlast
                sizeMultiplier = 1.4
                effect.Rate = (effect.Rate or 20) * 1.5
                effect.Lifetime = NumberRange.new(0.5, 1.2)
                effect.LightEmission = 1
                effect.LightInfluence = 0
                
                -- ç«ç„°æŠ–åŠ¨æ•ˆæœ
                effect.VelocitySpread = (effect.VelocitySpread or 10) * 1.8
                
            elseif isLava then
                scheme = LavaHellPalette.MagmaFlow
                sizeMultiplier = 1.6
                effect.Rate = (effect.Rate or 20) * 0.8  -- å²©æµ†æµåŠ¨è¾ƒæ…¢
                effect.Lifetime = NumberRange.new(1, 2.5)
                effect.LightEmission = 0.9
                
                -- å²©æµ†ç²˜ç¨ æ„Ÿ
                effect.Drag = (effect.Drag or 0) + 0.5
                effect.Acceleration = Vector3.new(0, -15, 0)  -- é‡åŠ›åŠ å¼º
                
            elseif isExplosion then
                scheme = LavaHellPalette.LavaSplash
                sizeMultiplier = 2.0
                effect.Rate = (effect.Rate or 20) * 3
                effect.Lifetime = NumberRange.new(0.3, 0.8)
                effect.LightEmission = 1
                
                -- çˆ†ç‚¸å†²å‡»æ•ˆæœ
                effect.Speed = NumberRange.new(15, 40)
                effect.SpreadAngle = Vector2.new(180, 180)  -- å…¨å‘çˆ†ç‚¸
                
            elseif isSmoke then
                scheme = LavaHellPalette.VolcanicSmoke
                sizeMultiplier = 1.3
                effect.Rate = (effect.Rate or 20) * 1.2
                effect.LightEmission = 0.2
                effect.LightInfluence = 1
                
                -- ç«å±±çƒŸé›¾ç‰¹æ€§
                effect.Drag = (effect.Drag or 0) + 0.3
                effect.Rotation = NumberRange.new(-180, 180)
                
            else
                -- éšæœºåœ°ç‹±æ–¹æ¡ˆ
                local hellSchemes = {
                    LavaHellPalette.EmberPulse,
                    LavaHellPalette.CrackGlow,
                    LavaHellPalette.HellfireBlast
                }
                scheme = hellSchemes[math.random(1, #hellSchemes)]
                sizeMultiplier = 1.2
            end
            
            effect.Color = scheme
            
            -- å¤§å°å˜åŒ–ï¼ˆæ¨¡ä»¿ç†”å²©è„‰åŠ¨ï¼‰
            effect.Size = NumberSequence.new({
                NumberSequenceKeypoint.new(0, (effect.Size and effect.Size.Keypoints[1].Value or 1) * sizeMultiplier * 0.7),
                NumberSequenceKeypoint.new(0.3, (effect.Size and effect.Size.Keypoints[1].Value or 1) * sizeMultiplier * 1.5),
                NumberSequenceKeypoint.new(0.6, (effect.Size and effect.Size.Keypoints[1].Value or 1) * sizeMultiplier * 0.9),
                NumberSequenceKeypoint.new(1, (effect.Size and effect.Size.Keypoints[1].Value or 1) * sizeMultiplier * 0.5)
            })
            
            -- é€æ˜åº¦å˜åŒ–ï¼ˆä»äº®åˆ°æš—ï¼‰
            effect.Transparency = NumberSequence.new({
                NumberSequenceKeypoint.new(0, 0),
                NumberSequenceKeypoint.new(0.7, 0.1),
                NumberSequenceKeypoint.new(1, 0.8)
            })
            
            -- ç†”å²©ç‰¹æœ‰çš„æ°”æ³¡/æ²¸è…¾æ•ˆæœ
            if math.random(1, 3) == 1 then
                effect.Texture = "rbxassetid://241602659"  -- å™ªå£°çº¹ç†æ¨¡æ‹Ÿæ²¸è…¾
            end
            
        elseif effect:IsA("Beam") then
            -- åœ°ç‹±å…‰æŸï¼ˆå²©æµ†æµï¼‰
            effect.Color = LavaHellPalette.MagmaFlow
            effect.Width0 = (effect.Width0 or 0.5) * 1.5
            effect.Width1 = (effect.Width1 or 0.5) * 1.5
            effect.Texture = "rbxassetid://446111271"  -- é—ªç”µçº¹ç†æ¨¡æ‹Ÿç†”å²©æµåŠ¨
            effect.TextureSpeed = 1.5
            effect.LightEmission = 0.9
            effect.TextureLength = 3
            
            -- ç†”å²©æµåŠ¨æ„Ÿ
            effect.CurveSize0 = 0.5
            effect.CurveSize1 = 0.5
            
        elseif effect:IsA("Trail") then
            -- ç†”å²©è½¨è¿¹
            effect.Color = LavaHellPalette.EmberPulse
            effect.LightEmission = 0.8
            effect.Transparency = NumberSequence.new({
                NumberSequenceKeypoint.new(0, 0),
                NumberSequenceKeypoint.new(0.5, 0.2),
                NumberSequenceKeypoint.new(1, 1)
            })
            effect.WidthScale = NumberSequence.new({
                NumberSequenceKeypoint.new(0, 1),
                NumberSequenceKeypoint.new(0.7, 0.5),
                NumberSequenceKeypoint.new(1, 0)
            })
            
        elseif effect:IsA("Smoke") then
            -- ç«å±±çƒŸé›¾
            effect.Color = Color3.fromRGB(50, 50, 50)
            effect.Opacity = 0.4
            effect.RiseVelocity = (effect.RiseVelocity or 1) * 1.8  -- ç«å±±çƒŸé›¾ä¸Šå‡å¿«
            effect.Size = (effect.Size or 4) * 2.0
            effect.Color = LavaHellPalette.VolcanicSmoke
            
        elseif effect:IsA("Fire") then
            -- åœ°ç‹±ç«ç„°
            effect.Color = LavaHellPalette.HellfireBlast
            effect.Size = (effect.Size or 5) * 1.8
            effect.Heat = (effect.Heat or 10) * 1.5  -- æ›´é«˜çƒ­é‡
            effect.SecondaryColor = LavaHellPalette.CharcoalGray
            
            -- ç«ç„°å¤§å°æ³¢åŠ¨
            spawn(function()
                while effect.Parent do
                    effect.Size = (effect.Size or 5) * 1.2
                    wait(0.3)
                    effect.Size = (effect.Size or 5) * 0.8
                    wait(0.3)
                end
            end)
            
        elseif effect:IsA("Sparkles") then
            -- ç«æ˜Ÿ/ä½™çƒ¬
            effect.SparkleColor = LavaHellPalette.MagmaCore
            effect.SparkleSize = (effect.SparkleSize or 1) * 2.5
            effect.TimeScale = 0.6  -- ç¼“æ…¢é—ªçƒ
            
        elseif effect:IsA("Explosion") then
            -- ç«å±±çˆ†å‘
            effect.BlastPressure = (effect.BlastPressure or 500) * 1.8
            effect.BlastRadius = (effect.BlastRadius or 5) * 2.0
            effect.DestroyJointRadiusPercent = 0.3
            effect.ExplosionType = Enum.ExplosionType.CratersAndDebris
        end
        
        -- æ·»åŠ åœ°ç‹±æ ‡è®°
        effect:SetAttribute("LavaHell", true)
        effect:SetAttribute("HeatLevel", isFire and "High" or isLava and "Extreme" or "Medium")
        effect:SetAttribute("BurnIntensity", math.random(70, 100) / 100)
        
        -- å¦‚æœæ˜¯é«˜æ¸©ç‰¹æ•ˆï¼Œæ·»åŠ éšæœºé—ªçƒ
        if effect:IsA("ParticleEmitter") and (isFire or isLava or isExplosion) then
            spawn(function()
                while effect.Parent and effect:GetAttribute("LavaHell") do
                    wait(math.random(0.2, 1.5))
                    local originalColor = effect.Color
                    effect.Color = LavaHellPalette.HellfireBlast  -- é—ªçƒçº¢è‰²
                    wait(0.1)
                    effect.Color = originalColor
                end
            end)
        end
    end)
end

-- ğŸŒ‹ åº”ç”¨æ‰€æœ‰åœ°ç‹±ç‰¹æ•ˆ
local function applyAllLavaHell()
    print("ğŸŒ‹ å¼€å§‹åº”ç”¨ç†”å²©åœ°ç‹±ç‰¹æ•ˆ...")
    local effectTypes = {"ParticleEmitter", "Beam", "Trail", "Smoke", "Fire", "Sparkles", "Explosion", "Light"}
    local totalEffects = 0
    local hellEffects = 0
    
    for _, descendant in ipairs(game:GetDescendants()) do
        for _, effectType in ipairs(effectTypes) do
            if descendant:IsA(effectType) then
                totalEffects = totalEffects + 1
                if not descendant:GetAttribute("LavaHell") then
                    applyLavaHellEffect(descendant)
                    hellEffects = hellEffects + 1
                end
            end
        end
    end
    
    print(string.format("ğŸ”¥ ç†”å²©åœ°ç‹±åº”ç”¨å®Œæˆï¼æ€»è®¡ %d ä¸ªç‰¹æ•ˆï¼Œè½¬åŒ– %d ä¸ªåœ°ç‹±æ•ˆæœ", totalEffects, hellEffects))
    
    -- å…¨å±€åœ°ç‹±ç³»ç»Ÿ
    _G.LavaHellSystem = {
        Reapply = applyAllLavaHell,
        Intensify = function(multiplier)
            -- å¢å¼ºç«ç„°å¼ºåº¦
            multiplier = multiplier or 1.3
            for _, effect in ipairs(game:GetDescendants()) do
                if effect:GetAttribute("LavaHell") then
                    if effect:IsA("ParticleEmitter") then
                        effect.Rate = (effect.Rate or 20) * multiplier
                        effect.Speed = NumberRange.new(
                            (effect.Speed and effect.Speed.Min or 2) * multiplier,
                            (effect.Speed and effect.Speed.Max or 5) * multiplier
                        )
                    elseif effect:IsA("Fire") then
                        effect.Size = (effect.Size or 5) * multiplier
                        effect.Heat = (effect.Heat or 10) * multiplier
                    end
                end
            end
            print("ğŸ”¥ åœ°ç‹±ç«ç„°å¼ºåº¦å¢å¼º:", multiplier)
        end,
        CoolDown = function()
            -- å†·å´æ•ˆæœï¼ˆå˜æš—ï¼‰
            for _, effect in ipairs(game:GetDescendants()) do
                if effect:GetAttribute("LavaHell") then
                    if effect:IsA("ParticleEmitter") then
                        effect.Color = LavaHellPalette.EmberPulse  -- å˜æˆä½™çƒ¬
                        effect.LightEmission = math.max((effect.LightEmission or 1) * 0.5, 0.3)
                    elseif effect:IsA("Fire") then
                        effect.Size = (effect.Size or 5) * 0.5
                    end
                end
            end
            print("â„ï¸ åœ°ç‹±ç«ç„°å†·å´ä¸­...")
        end,
        Erupt = function()
            -- ç«å±±çˆ†å‘æ¨¡å¼
            for _, effect in ipairs(game:GetDescendants()) do
                if effect:GetAttribute("LavaHell") and effect:IsA("ParticleEmitter") then
                    effect.Acceleration = Vector3.new(0, 30, 0)  -- å¼ºåŠ›å‘ä¸Š
                    effect.Speed = NumberRange.new(20, 50)
                    effect.Rate = (effect.Rate or 20) * 3
                    effect.Lifetime = NumberRange.new(3, 5)
                end
            end
            print("ğŸ’¥ ç«å±±çˆ†å‘æ¨¡å¼æ¿€æ´»ï¼")
        end
    }
    
    return hellEffects
end

-- ğŸ”¥ åˆå§‹æ‰§è¡Œ
applyAllLavaHell()

print("ğŸŒ‹ ç†”å²©åœ°ç‹±ç³»ç»Ÿå·²æ¿€æ´»")
print("ğŸ”¥ å²©æµ†æ©™ + åœ°ç‹±ç«çº¢ + ç†”é‡‘ + ç„¦ç‚­é»‘")
print("ğŸ’€ å»ºè®®é…åˆç«å±±/åœ°ç‹±åœºæ™¯ä½¿ç”¨")

-- ğŸ”„ ç›‘å¬æ–°ç‰¹æ•ˆ
game.DescendantAdded:Connect(function(newDescendant)
    task.wait(0.1)
    local effectTypes = {"ParticleEmitter", "Beam", "Trail", "Smoke", "Fire", "Sparkles", "Explosion", "Light"}
    for _, effectType in ipargs(effectTypes) do
        if newDescendant:IsA(effectType) then
            task.wait(0.15)
            if not newDescendant:GetAttribute("LavaHell") then
                applyLavaHellEffect(newDescendant)
                print("ğŸŒ¡ï¸ æ–°å¢åœ°ç‹±æ•ˆæœ:", newDescendant:GetFullName())
            end
        end
    end
end)

-- ğŸ”ï¸ åœ°ç‹±ç¯å¢ƒå…‰è®¾ç½®
local function setupHellEnvironment()
    if game:GetService("Lighting") then
        local lighting = game:GetService("Lighting")
        
        -- åœ°ç‹±é£æ ¼ç¯å…‰
        lighting.Ambient = Color3.fromRGB(50, 20, 10)
        lighting.OutdoorAmbient = Color3.fromRGB(70, 30, 15)
        lighting.Brightness = 1.2
        lighting.ColorShift_Bottom = Color3.fromRGB(100, 40, 0)
        lighting.ColorShift_Top = Color3.fromRGB(150, 50, 0)
        
        -- çº¢è‰²è‰²è°ƒ
        if lighting:FindFirstChild("ColorCorrection") then
            lighting.ColorCorrection.TintColor = Color3.fromRGB(255, 200, 150)
            lighting.ColorCorrection.Contrast = 0.2
            lighting.ColorCorrection.Brightness = 0.1
        end
        
        -- æ·»åŠ é›¾æ•ˆ
        lighting.FogColor = Color3.fromRGB(40, 15, 5)
        lighting.FogStart = 30
        lighting.FogEnd = 200
        
        -- æ·»åŠ Bloomï¼ˆæ¨¡æ‹Ÿçƒ­æµªï¼‰
        if lighting:FindFirstChild("BloomEffect") then
            lighting.BloomEffect.Enabled = true
            lighting.BloomEffect.Intensity = 0.7
            lighting.BloomEffect.Size = 32
            lighting.BloomEffect.Threshold = 0.7
            lighting.BloomEffect.Enabled = true
        end
    end
end

-- ğŸŒ¡ï¸ æ¸©åº¦æ§åˆ¶å‡½æ•°
function AdjustHeatLevel(level)
    level = math.clamp(level or 1, 0.3, 3)
    
    for _, effect in ipairs(game:GetDescendants()) do
        if effect:GetAttribute("LavaHell") then
            local heat = effect:GetAttribute("HeatLevel")
            
            if effect:IsA("ParticleEmitter") then
                -- è°ƒæ•´é¢œè‰²æ¸©åº¦
                if level > 1.5 then
                    effect.Color = LavaHellPalette.HellfireBlast  -- é«˜æ¸©å˜çº¢
                elseif level < 0.7 then
                    effect.Color = LavaHellPalette.EmberPulse     -- ä½æ¸©ä½™çƒ¬
                end
                
                -- è°ƒæ•´ç²’å­é€Ÿåº¦
                effect.Speed = NumberRange.new(
                    (effect.Speed and effect.Speed.Min or 2) * level,
                    (effect.Speed and effect.Speed.Max or 5) * level
                )
                
            elseif effect:IsA("Fire") then
                effect.Size = (effect.Size or 5) * level
                effect.Heat = (effect.Heat or 10) * level
            end
        end
    end
    
    print("ğŸŒ¡ï¸ åœ°ç‹±æ¸©åº¦è°ƒæ•´è‡³:", string.format("%.1f", level))
end

-- ğŸª¨ ç”Ÿæˆç†”å²©è£‚ç¼æ•ˆæœ
function CreateLavaCracks(position)
    local part = Instance.new("Part")
    part.Size = Vector3.new(10, 0.2, 10)
    part.Position = position
    part.Anchored = true
    part.CanCollide = false
    part.Material = Enum.Material.Neon
    part.Color = LavaHellPalette.CharcoalGray
    part.Parent = workspace
    
    -- è£‚ç¼å‘å…‰
    local pointLight = Instance.new("PointLight")
    pointLight.Color = LavaHellPalette.MagmaCore
    pointLight.Brightness = 3
    pointLight.Range = 15
    pointLight.Parent = part
    
    -- è£‚ç¼ç²’å­
    local particle = Instance.new("ParticleEmitter")
    particle.Color = LavaHellPalette.CrackGlow
    particle.Size = NumberSequence.new(0.5, 2)
    particle.Transparency = NumberSequence.new(0, 0.8)
    particle.Lifetime = NumberRange.new(0.5, 1.5)
    particle.Rate = 50
    particle.Speed = NumberRange.new(2, 8)
    particle.SpreadAngle = Vector2.new(60, 60)
    particle.Parent = part
    
    -- è„‰åŠ¨æ•ˆæœ
    spawn(function()
        while part.Parent do
            pointLight.Brightness = 5
            particle.Rate = 80
            wait(0.8)
            pointLight.Brightness = 2
            particle.Rate = 30
            wait(1.2)
        end
    end)
    
    print("ğŸª¨ ç†”å²©è£‚ç¼ç”Ÿæˆäº:", position)
    return part
end

-- å¯¼å‡ºæ¨¡å—
return {
    Apply = applyAllLavaHell,
    Heat = AdjustHeatLevel,
    Erupt = _G.LavaHellSystem and _G.LavaHellSystem.Erupt,
    Cool = _G.LavaHellSystem and _G.LavaHellSystem.CoolDown,
    Environment = setupHellEnvironment,
    CreateCrack = CreateLavaCracks,
    Colors = LavaHellPalette
}
